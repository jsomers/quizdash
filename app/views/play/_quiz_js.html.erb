<script type="text/javascript">
	var QUIZ = {
		nick: "jsomers",
		id: null,
		focus: true,
		mark_correct: function(q, ans) {
			var q = $(".repositories > li[qid=" + q + "]").addClass("correct");
	    	q.find("h3").html(ans).removeClass("hint");
	    	q.find("ul.repo-stats").effect("highlight", {color: "yellow"}, 500);
	    	q.effect("highlight", {color: "yellow"}, 500);
	    	q.find("img").show();
		}
	};

	$(document).ready(function() {		
		dash_hash = "<%= @hash %>";
		quiz_id = "<%= @quiz.id %>";
		time_limit = <%= @quiz.time_limit %>;
		
		answers = <%= raw(@quiz.answer_map.to_json) %>;
		n_questions = <%= @quiz.questions.length %>;
		seen = {}; // TODO: This should probably be in QUIZ object, as should answers.
		
		jug = new Juggernaut;
		jug.on("connect", function() {
			$.get("/dashes/get/" + dash_hash, 
				function(ret) {
					dash = JSON.parse(ret);
					//leaderboard.new(dash.board);

					QUIZ.nick = prompt("Enter your handle, please", "zero_cool");
					//CONFIG.nick = "player " + Math.floor(Math.random() * 101);
					var pointices = new_filled_array(n_questions, 0);
					var slot = [QUIZ.nick, pointices];

					$.post("/dashes/add_slot/", {dash_id: dash_hash, slot: JSON.stringify(slot)});
				}
			)

		});

		jug.subscribe("/" + dash_hash, function(ret) {
			data = JSON.parse(ret);
			if (data.board) {
				leaderboard.new(data.board);
			};
			
			if (data.msg) {
				switch (data.msg) {
					case "start_countdown":
						begin_countdown();
						break;
				}
			}
		})
		
		$("#answer").keyup(function() {
	    	var ans = $("#answer").val().toLowerCase();
	    	var qid = answers[ans];
	    	if (typeof(qid) != "undefined" && typeof(seen[qid]) == "undefined") {
	    		QUIZ.mark_correct(qid, ans);
	    		$("#answer").val("");
	    		seen[qid] = true;
	    		$.post("/dashes/mark_q/",
	    		    {dash_id: dash_hash, quiz_id: quiz_id, qid: qid, plyr: QUIZ.nick},
	    		    function(ret) {
	                    console.log(ret);
	    		    }
	    		)
	    	};
	    });
	
		pad = function(n) {
			if (n < 10) {
				return "0" + n;
			} else { return "" + n };
		}
	
		pretty_time = function(m, s, i) {
			if (typeof i == "undefined") {
				return pad(m) + ":" + pad(s);
			} else { 
				return pad(m) + ":" + pad(s) + "." + i;
			};
		};
	
		tick = function(selector, m, s, i) {
			if (m == 0 && s == 0 && i == 0) {
				end_dash();
				return false;
			}
			if (typeof i == "undefined") {
				if (s == 0) {
					m -= 1;
					s = 59;
				} else {
					s -= 1;
				};
				if (m < 1) {
					var i = 9;
					setTimeout("tick(\"" + selector + "\", " + m + ", " + s + ", " + i + ")", 100);
				} else {
					setTimeout("tick(\"" + selector + "\", " + m + ", " + s + ", " + i + ")", 1000);
				}
			} else {
				if (i == 0 && s > 0) {
					s -= 1;
					i = 10;
				};
				if (i == 0 && s == 0) {
					m -= 1;
					s = 59;
					i = 10;
				}
				i -= 1;
				setTimeout("tick(\"" + selector + "\", " + m + ", " + s + ", " + i + ")", 100);
			};
			$(selector).html( pretty_time(m, s, i) );
		};
		
		start = function(minutes) {
			tick(".clock span", minutes, 0);
		};
		
		
		end_countdown = function() {
			$("#countdown_container").hide();
			$("#overlay").hide();
			$("#questions").css("opacity", "1.0");
			$("#answer").attr("disabled", false).focus();
			start(time_limit);
		}
		
		countdown = function(n) {
			$("#countdown_clock span").html(n);
			if (n > 0) { 
				setTimeout("countdown(" + (n - 1) + ")", 1000);
			} else {
				end_countdown();
			}
		}
		
		begin_countdown = function() {
			$("#answer").attr("disabled", true);
			var page_size = ___getPageSize();
			$("#overlay").css("width", page_size[0]).css("height", page_size[1]).show();
			$("#countdown_container").css("left", (page_size[0] / 2) - 100 + "px").show();
			countdown(9);
		};
		
		end_dash = function() {
			$("#answer").attr("disabled", true);
			var page_size = ___getPageSize();
			$("#overlay").css("width", page_size[0]).css("height", page_size[1]).show();
			$("#countdown_container").css("left", (page_size[0] / 2) - 350 + "px").show();
			$("#countdown_clock span").html("game over");
		}
		
	});
</script>